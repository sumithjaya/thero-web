version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Pin Node to LTS (uses .nvmrc if present, else falls back to 20.17.0)
        - if command -v nvm >/dev/null 2>&1; then nvm install && nvm use; else echo "nvm not found; using system Node"; fi
        - if [ -f .nvmrc ]; then echo "Using $(cat .nvmrc) from .nvmrc"; else echo "20.17.0" > .nvmrc && echo "Using 20.17.0 (written to .nvmrc)"; fi
        - nvm install "$(cat .nvmrc)" || true
        - nvm use "$(cat .nvmrc)" || true
        - node -v
        - npm -v

        # Deterministic install with npm (requires package-lock.json in repo)
        - npm ci --ignore-scripts=false
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - ~/.npm/**/*   # npm cache (safe to keep)
